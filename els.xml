<?xml version="1.0" encoding="UTF-8"?>
<project name="ELS Build" default="all" basedir=".">

    <target name="init">
        <property file="els.properties"/>
        <echo message="ELS version ${els.version.number}, ${els.version.name}" level="info"/>
        <echo message="${java.vendor} ${java.runtime.name} ${java.runtime.version}" level="info"/>
        <echo message="${ant.version}" level="info"/>
        <path id="class.path">
            <fileset dir="lib">
                <include name="*.jar"/>
            </fileset>
        </path>
    </target>

    <target name="clean" depends="init">
        <delete dir="out" failonerror="false"/>
        <mkdir dir="out"/>
    </target>

    <!-- Build stamp and copy locales to default -->
    <target name="stamp" depends="clean" description="Copy default locale amd set build stamp">
        <!-- Write the build timestamp -->
        <tstamp>
            <format property="STRINGNOW" pattern="d MMMM yyyy, HH:mm zzz" locale="en,US"/>
            <format property="NUMBERNOW" pattern="yyMMddHHmm" locale="en,US"/>
        </tstamp>
        <echo file="src/com/groksoft/els/resources/buildstamp.txt" append="false">${STRINGNOW}</echo>
        <!-- Write the version.info file -->
        <delete file="deploy/version.info" failonerror="false"/>
        <echo file="deploy/version.info" append="false">${NUMBERNOW}${line.separator}</echo>
        <echo file="deploy/version.info" append="true">${STRINGNOW}${line.separator}</echo>
        <echo file="deploy/version.info" append="true">${els.version.number}${line.separator}</echo>
        <echo file="deploy/version.info" append="true">${els.version.name}${line.separator}</echo>
        <echo message="Build stamp ${NUMBERNOW}, ${STRINGNOW}" level="info"/>
        <!-- Copy the IDE default bundle to the en_US bundle -->
        <copy overwrite="true" file="src/com/groksoft/els/locales/bundle.properties" tofile="src/com/groksoft/els/locales/bundle_en_US.properties"/>
    </target>

    <!-- Compile ELS -->
    <target name="compile" depends="stamp">
        <delete dir="out" failonerror="false"/>
        <mkdir dir="out"/>
        <mkdir dir="out/jar"/>
        <javac destdir="out/jar" classpathref="class.path" includeantruntime="false" debug="on">
            <src path="src"/>
            <include name="**/*.java"/>
        </javac>
    </target>

    <!-- Assemble all the pieces to build the Jar -->
    <target name="assemble" depends="compile">
        <copy todir="out/jar/com/groksoft/els/locales" preservelastmodified="true">
            <fileset dir="src/com/groksoft/els/locales"/>
        </copy>
        <copy todir="out/jar/com/groksoft/els/resources" preservelastmodified="true">
            <fileset dir="src/com/groksoft/els/resources"/>
        </copy>
        <copy todir="out/jar" preservelastmodified="true">
            <fileset dir="artifacts/images/"/>
            <fileset dir="src/com/groksoft/els/locales/"/>
            <fileset dir="src/com/groksoft/els/resources/"/>
        </copy>
        <copy file="lib/log4j2.xml" todir="out/jar" preservelastmodified="true"/>
        <unzip dest="out/jar">
            <fileset dir="lib">
                <include name="**/*.jar"/>
            </fileset>
        </unzip>
    </target>

    <!-- Build ELS.jar -->
    <target name="jar" depends="assemble" description="Build ELS.jar">
        <manifest file="out/jar/META-INF/MANIFEST.MF">
            <attribute name="Main-Class" value="com.groksoft.els.Main"/>
        </manifest>
        <jar destfile="deploy/ELS.jar" manifest="out/jar/META-INF/MANIFEST.MF">
            <fileset dir="out/jar" includes="**/"/>
        </jar>
    </target>

    <!-- Build Linux .tar.gz -->
    <target name="linux" depends="jar" description="Build Linux .tar.gz">
        <delete failonerror="false">
            <fileset dir="deploy">
                <include name="*.tar.gz"/>
            </fileset>
        </delete>
        <mkdir dir="out/tar/ELS"/>
        <copy todir="out/tar/ELS" preservelastmodified="true">
            <fileset dir="artifacts/stage/linux"/>
        </copy>
        <copy file="artifacts/images/els-logo-98px.ico" todir="out/tar/ELS/bin" preservelastmodified="true"/>
        <copy file="artifacts/images/els-logo-98px.png" todir="out/tar/ELS/bin" preservelastmodified="true"/>
        <copy file="deploy/ELS.jar" todir="out/tar/ELS/bin" preservelastmodified="true"/>
        <untar dest="out/tar/ELS/rt" src="artifacts/stage/rt-archives/OpenJDK8-linux.tar.gz" compression="gzip"/>
        <tar destfile="deploy/ELS-${els.version.name}-Linux-${NUMBERNOW}.tar.gz" compression="gzip">
            <tarfileset dir="out/tar" filemode="775">
                <include name="ELS/ELS-Navigator.sh"/>
            </tarfileset>
            <tarfileset dir="out/tar" filemode="775">
                <include name="ELS/rt/bin/*"/>
            </tarfileset>
            <tarfileset dir="out/tar">
                <exclude name="ELS/ELS-Navigator.sh"/>
                <exclude name="ELS/rt/bin/*"/>
            </tarfileset>
        </tar>
    </target>

    <!-- Build Windows .zip -->
    <target name="windows" depends="jar" description="Build Windows .zip">
        <delete failonerror="false">
            <fileset dir="deploy">
                <include name="*.zip"/>
            </fileset>
        </delete>
        <mkdir dir="out/zip/ELS"/>
        <copy todir="out/zip/ELS" preservelastmodified="true">
            <fileset dir="artifacts/stage/windows"/>
        </copy>
        <copy file="artifacts/images/els-logo-98px.ico" todir="out/zip/ELS/bin" preservelastmodified="true"/>
        <copy file="artifacts/images/els-logo-98px.png" todir="out/zip/ELS/bin" preservelastmodified="true"/>
        <copy file="deploy/ELS.jar" todir="out/zip/ELS/bin" preservelastmodified="true"/>
        <unzip dest="out/zip/ELS/rt" src="artifacts/stage/rt-archives/OpenJDK8-windows.zip"/>
        <zip destfile="deploy/ELS-${els.version.name}-Windows-${NUMBERNOW}.zip">
            <zipfileset dir="out/zip" includes="**/*"/>
        </zip>
    </target>

    <target name="all" depends="linux, windows" description="Build everything"/>

</project>

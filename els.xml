<?xml version="1.0" encoding="UTF-8"?>
<project name="ELS Build" default="all" basedir=".">

    <target name="init">
        <property file="els.properties"/>
        <echo message="ELS version ${els.version}"/>
        <echo message="${java.vendor} ${java.runtime.name} ${java.runtime.version}"/>
        <echo message="${ant.version}"/>
        <path id="class.path">
            <fileset dir="lib">
                <include name="*.jar"/>
            </fileset>
        </path>
    </target>

    <target name="clean" depends="init">
        <delete dir="out" failonerror="false"/>
        <mkdir dir="out"/>
    </target>

    <!-- Build stamp and copy locales to default -->
    <target name="stamp" depends="clean">
        <!-- Copy the IDE default bundle to the en_US bundle -->
        <copy overwrite="true" file="src/com/groksoft/els/locales/bundle.properties" tofile="src/com/groksoft/els/locales/bundle_en_US.properties"/>
        <!-- Generate a build timestamp -->
        <tstamp>
            <format property="RIGHTNOW" pattern="d MMMM yyyy, HH:mm zzz" locale="en,US"/>
        </tstamp>
        <echo file="src/com/groksoft/els/resources/buildstamp.txt" append="false">${RIGHTNOW}</echo>
    </target>

    <!-- Compile ELS & assemble all the pieces to build the Jar -->
    <target name="compile" depends="stamp">
        <mkdir dir="out/jar"/>
        <javac destdir="out/jar" classpathref="class.path" includeantruntime="false" debug="on">
            <src path="src"/>
            <include name="**/*.java"/>
        </javac>
        <copy todir="out/jar/com/groksoft/els/locales">
            <fileset dir="src/com/groksoft/els/locales"/>
        </copy>
        <copy todir="out/jar/com/groksoft/els/resources">
            <fileset dir="src/com/groksoft/els/resources"/>
        </copy>
        <copy todir="out/jar">
            <fileset dir="artifacts/images/"/>
            <fileset dir="src/com/groksoft/els/locales/"/>
            <fileset dir="src/com/groksoft/els/resources/"/>
        </copy>
        <copy file="lib/log4j2.xml" todir="out/jar"/>
        <unzip dest="out/jar">
            <fileset dir="lib">
                <include name="**/*.jar"/>
            </fileset>
        </unzip>
    </target>

    <!-- Build ELS.jar -->
    <target name="jar" depends="compile">
        <manifest file="out/jar/META-INF/MANIFEST.MF">
            <attribute name="Main-Class" value="com.groksoft.els.Main"/>
        </manifest>
        <jar destfile="deploy/ELS.jar" manifest="out/jar/META-INF/MANIFEST.MF">
            <fileset dir="out/jar" includes="**/"/>
        </jar>
    </target>

    <!-- Build Linux .tar.gz -->
    <target name="linux" depends="jar">
        <mkdir dir="out/tar/ELS"/>
        <copy todir="out/tar/ELS">
            <fileset dir="artifacts/stage/linux"/>
        </copy>
        <copy file="artifacts/images/els-logo-98px.ico" todir="out/tar/ELS/bin"/>
        <copy file="artifacts/images/els-logo-98px.png" todir="out/tar/ELS/bin"/>
        <copy file="deploy/ELS.jar" todir="out/tar/ELS/bin"/>
        <untar dest="out/tar/ELS/rt" src="artifacts/stage/rt-archives/OpenJDK8-linux.tar.gz" compression="gzip"/>
        <chmod file="out/tar/ELS/ELS-Navigator.sh" perm="775"/>
        <tar destfile="deploy/ELS-${els.version}-Linux.tar.gz" compression="gzip">
            <tarfileset dir="out/tar" filemode="775">
                <include name="ELS/ELS-Navigator.sh"/>
            </tarfileset>
            <tarfileset dir="out/tar" filemode="775">
                <include name="ELS/rt/bin/*"/>
            </tarfileset>
            <tarfileset dir="out/tar">
                <exclude name="ELS/ELS-Navigator.sh"/>
                <exclude name="ELS/rt/bin/*"/>
            </tarfileset>
        </tar>
    </target>

    <!-- Build Windows .zip -->
    <target name="windows" depends="jar">
        <mkdir dir="out/zip/ELS"/>
        <copy todir="out/zip/ELS">
            <fileset dir="artifacts/stage/windows"/>
        </copy>
        <copy file="artifacts/images/els-logo-98px.ico" todir="out/zip/ELS/bin"/>
        <copy file="artifacts/images/els-logo-98px.png" todir="out/zip/ELS/bin"/>
        <copy file="deploy/ELS.jar" todir="out/zip/ELS/bin"/>
        <unzip dest="out/zip/ELS/rt" src="artifacts/stage/rt-archives/OpenJDK8-windows.zip"/>
        <zip destfile="deploy/ELS-${els.version}-Windows.zip">
            <zipfileset dir="out/zip" includes="**/*"/>
        </zip>
    </target>

    <target name="all" depends="linux, windows"/>

</project>
